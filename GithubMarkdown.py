#!/usr/bin/env python
# -*- coding: utf-8 -*-

import re
from hashlib import md5


class GithubMarkdown(object):

    """Classe para representar um texto formato com
       a sintaxe do Markdown adotada pelo github.
    """

    def __init__(self, text):
        """TODO: to be defined1. """
        self.__content = self.parse(text)

    def get_content(self):
        """TODO: Docstring for get_content.
        :returns: TODO

        """
        if self.__content is None:
            return None
        else:
            return self.__content

    def parse(self, text):
        # Extract pre blocks.
        extractions = {}

        def pre_extraction_callback(matchobj):

            digest = md5(matchobj.group(0)).hexdigest()
            extractions[digest] = matchobj.group(0)
            return "{gfm-extraction-%s}" % digest
        pattern = re.compile(r'<pre>.*?</pre>', re.MULTILINE | re.DOTALL)
        text = re.sub(pattern, pre_extraction_callback, text)

        # Prevent foo_bar_baz from ending up with an italic word in the middle.
        def italic_callback(matchobj):
            s = matchobj.group(0)
            if list(s).count('_') >= 2:
                return s.replace('_', '\_')
            return s
        text = re.sub(r'^(?! {4}|\t)\w+_\w+_\w[\w_]*', italic_callback, text)

        # In very clear cases, let newlines become <br /> tags.
        def newline_callback(matchobj):
            if len(matchobj.group(1)) == 1:
                return matchobj.group(0).rstrip() + '  \n'
            else:
                return matchobj.group(0)
        pattern = re.compile(r'^[\w\<][^\n]*(\n+)', re.MULTILINE)
        text = re.sub(pattern, newline_callback, text)

        # Insert pre block extractions.
        def pre_insert_callback(matchobj):
            return '\n\n' + extractions[matchobj.group(1)]
        text = re.sub(r'{gfm-extraction-([0-9a-f]{32})\}',
                      pre_insert_callback,
                      text
                      )
        return text
